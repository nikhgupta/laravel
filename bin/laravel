#!/usr/bin/env ruby
# encoding: UTF-8

# resolve bin path, ignoring symlinks
require "pathname"
bin_file = Pathname.new(__FILE__).realpath

# add self to libpath
$:.unshift File.expand_path(File.join(%w[ .. .. lib]), bin_file)

require "laravel" # which indirectly requires 'thor'

module Laravel
  class CLI < Thor

    # display version/information about this gem
    # default   => display usage information for the gem
    # --version => display current Laravel version
    desc "info", "displays usage information about this gem."
    method_options %w( version -v) => :boolean
    def info
      puts options[:version] ? "Laravel v#{Laravel::VERSION}" : Laravel::INFO
      # puts "Made possible by efforts of Laravel Community"
    end

    # create a new laravel application
    # default  => create a bare bone Laravel application
    # --local  => use a local directory for source
    # --remote => use a remote git repository for source
    # --force  => overwrite target directory, if it exists
    # --index  => update Application Index for newly created application
    # --key    => generate a new key for this application
    # --no_perms => do not update permissions on storage/ directory
    desc "new [MY_APP]", "create a new Laravel application"
    method_option :local,  :type => :string,  :aliases => "-l", :banner => "DIRECTORY",
      :desc => "use laravel source from a local directory"
    method_option :remote, :type => :string,  :aliases => "-r", :banner => "GIT_REPO",
      :desc => "use this git repository instead (useful when working with forks, e.g.)"
    method_option :force,  :type => :boolean, :desc => "force overwrite"
    method_option :index,  :type => :string,  :aliases => "-i",
      :desc => "change the Application Index"
    method_option :key,    :type => :boolean, :aliases => "-k",
      :desc => "generate a new key for this application"
    method_option :no_perms, :type => :boolean, :desc => "do not update permissions on storage/ directory"
    def new(app_name)
      Laravel::Create::source app_name, options
    end

    # allow the user to modify Application Index
    # --app => use the given directory instead of pwd
    desc "update_index [NEW_INDEX]", "modify the Application Index for Laravel application"
    method_option :app, :type => :string, :aliases => "-a",
      :desc => "use the specified Laravel application instead of current directory"
    def update_index(new_index)
      Laravel::Manage::update_index new_index, options[:app]
    end

    desc "generate_key", "generate a new key for Laravel application"
    method_option :app, :type => :string, :aliases => "-a",
      :desc => "use the specified Laravel application instead of current directory"
    def generate_key
      Laravel::Manage::generate_key options[:app]
    end

    # choose a default task to run
    default_task :info

  end
end

Laravel::CLI.start # starts our CLI application
